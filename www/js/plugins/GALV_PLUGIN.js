/*:@author Galv's | https://galvs-scripts.com
Terms of use
Feel free to use my scripts in your game projects as long as you give credit. Scripts written by me are free for commercial use unless otherwise stated (see below).
Please do not repost my scripts/plugins in other places. Feel free to modify them for use in your own project but do not share/repost the modified script/plugin anywhere.
*/
var Galv={};Galv.BES=Galv.BES||{};
(()=>{Galv.BES.pShadows=(status)=>{$gameSystem._playerShadow=status;SceneManager._scene._spriteset.doActorShadows()};Galv.BES.eShadows=(status)=>{$gameSystem._eventShadows=status;SceneManager._scene._spriteset.doEventShadows()};Galv.BES.Game_System_initialize=Game_System.prototype.initialize;Game_System.prototype.initialize=function(){Galv.BES.Game_System_initialize.call(this);this._playerShadow=true;this._eventShadows=true};Spriteset_Map.prototype.hideCharacters=()=>{};Spriteset_Map.prototype.createCharacterShadows=
function(){this._bshadowSprites={};if(SceneManager.isScene()){this.doEventShadows().catch((e)=>console.log(e));this.doActorShadows().catch((e)=>console.log(e))}};Spriteset_Map.prototype.doEventShadows=async function(){for await(const e of $gameMap.events())if(e){const id=e.eventId()||0;if($gameSystem._eventShadows)await this.createBShadow(id,e);else await this.destroyBShadow(id,e)}};Spriteset_Map.prototype.doActorShadows=async function(){if($gameSystem._playerShadow){$gamePlayer._shadow=true;await this.createBShadow("f0",
$gamePlayer)}else{$gamePlayer._shadow=false;await this.destroyBShadow("f0",$gamePlayer)}};Spriteset_Map.prototype.createBShadow=async function(id,character){if(!character)return;if(!this._bshadowSprites)this._bshadowSprites={};if(!this._bshadowSprites.hasOwnProperty(id))if(character._shadow){this._bshadowSprites[id]=await new Sprite_BasicShadow(character);await this._tilemap.addChild(this._bshadowSprites[id]);character._shadSprite=true}};Spriteset_Map.prototype.destroyBShadow=async function(id,character){if(!this._bshadowSprites)this._bshadowSprites=
{};if(this._bshadowSprites.hasOwnProperty(id)){await this._tilemap.removeChild(this._bshadowSprites[id]);this._bshadowSprites[id]=null;delete this._bshadowSprites[id];if(character)character._shadSprite=false}};Spriteset_Map.prototype.destroyAllBShadows=async function(){$gamePlayer._shadow=false;await this.destroyBShadow("f0",$gamePlayer);$gameMap.events().forEach(function(event){this.destroyBShadow(event._eventId,event).catch((e)=>console.log(e))},this)};Galv.BES.Game_Event_refresh=Game_Event.prototype.refresh;
Game_Event.prototype.refresh=function(){Galv.BES.Game_Event_refresh.call(this);this.doShadows()};Game_Event.prototype.doShadows=function(){if(!$gameSystem._eventShadows){if(SceneManager._scene._spriteset)SceneManager._scene._spriteset.destroyBShadow(this._eventId);return}if(this.event().note.contains("<shadow>")&&this._characterName!=="")this._shadow=true;else{let page=this.page();let shadow=false;if(page)for(let i=0;i<page.list.length;i++)if(page.list[i].code===108&&page.list[i].parameters[0].contains("<shadow>"))shadow=
true;if(shadow){this._shadow=true;if(SceneManager._scene._spriteset)SceneManager._scene._spriteset.createBShadow(this._eventId,this)}else{this._shadow=false;if(SceneManager._scene._spriteset)SceneManager._scene._spriteset.destroyBShadow(this._eventId);this._shadSprite=false}}};Galv.BES.Game_Event_erase=Game_Event.prototype.erase;Game_Event.prototype.erase=function(){this._shadow=false;if(SceneManager._scene._spriteset)SceneManager._scene._spriteset.destroyBShadow(this._eventId);this._shadSprite=false;
Galv.BES.Game_Event_erase.call(this)};class Sprite_BasicShadow extends Sprite{constructor(character){super();this.initialize(character)}initialize(character){super.initialize();this._character=character;this.anchor.x=.5;this.anchor.y=1;const bt=ImageManager.loadSystem("IconSet");this.bitmap=new Bitmap(48,48);this.bitmap.blt(bt,96,0,32,32,0,0,48,48)}update(){this.x=this._character.screenX();this.y=this._character.screenY()-2+this._character.jumpHeight();this.z=this._character.screenZ()-1;if(this._character._transparent)this.opacity=
0;else this.opacity=this._character._opacity}}})();(()=>{Game_CharacterBase.prototype._cframes=3;Game_CharacterBase.prototype._spattern=1;Game_CharacterBase.prototype._patSpd=0;const Alias_Window_Base_drawCharacter=Window_Base.prototype.drawCharacter;Window_Base.prototype.drawCharacter=function(characterName,characterIndex,x,y){var setFrame=characterName.match(/\((.*)\)/i);if(setFrame){this._cframes=Number(setFrame[1]);var f=this._cframes;var bitmap=ImageManager.loadCharacter(characterName);var big=ImageManager.isBigCharacter(characterName);var pw=
bitmap.width/(big?f:f*4);var ph=bitmap.height/(big?4:8);var n=characterIndex;var sx=(n%4*3+1)*pw;var sy=Math.floor(n/4)*4*ph;this.contents.blt(bitmap,sx,sy,pw,ph,x-pw/2,y-ph)}else Alias_Window_Base_drawCharacter.call(this,characterName,characterIndex,x,y)};const Alias_Sprite_Character_setCharacterBitmap=Sprite_Character.prototype.setCharacterBitmap;Sprite_Character.prototype.setCharacterBitmap=function(){var setFrame=this._characterName.match(/\((.*)\)/i);if(setFrame){this._cframes=Number(setFrame[1]);
this._character._spattern=0;this._character._patSpd=3*.5-1}else{this._cframes=3;this._character._spattern=1;this._character._patSpd=0}this._character._cframes=this._cframes;Alias_Sprite_Character_setCharacterBitmap.call(this)};Game_CharacterBase.prototype.pattern=function(){return this._pattern<this._cframes?this._pattern:this._spattern};Game_CharacterBase.prototype.updatePattern=function(){if(!this.hasStepAnime()&&this._stopCount>0)this.resetPattern();else this._pattern=(this._pattern+1)%(this._cframes+
this._spattern)};const Alias_Game_CharacterBase_animationWait=Game_CharacterBase.prototype.animationWait;Game_CharacterBase.prototype.animationWait=function(){return Alias_Game_CharacterBase_animationWait.call(this)-this._patSpd};Sprite_Character.prototype.characterBlockX=function(){if(this._isBigCharacter)return 0;else{var index=this._character.characterIndex();return index%4*this._cframes}};Sprite_Character.prototype.patternWidth=function(){if(this._tileId>0)return $gameMap.tileWidth();else if(this._isBigCharacter)return this.bitmap.width/
this._cframes;else return this.bitmap.width/(this._cframes*4)}})();
