!function(e){function t(e){this.tileAnim=[0,0],this.dontUseTransform=!1,this.renderer=e,this.tileAnim=[0,0]}(e.tilemap||(e.tilemap={})).CanvasTileRenderer=t,e.CanvasRenderer.registerPlugin("tilemap",t)}(PIXI||(PIXI={}));var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(c){var p,a,e;function t(e,t,r,i){var n=a.call(this)||this;return n.shadowColor=new Float32Array([0,0,0,.5]),n.modificationMarker=0,n._globalMat=null,n._tempScale=null,n.initialize.apply(n,arguments),n}p=c.tilemap||(c.tilemap={}),a=c.Container,__extends(t,a),t.prototype.updateTransform=function(){a.prototype.displayObjectUpdateTransform.call(this)},t.prototype.initialize=function(e,t,r,i){this.z=this.zIndex=e,this.useSquare=r,this.texPerChild=i||16,t&&this.setBitmaps(t)},t.prototype.setBitmaps=function(e){var t,r=this.texPerChild,i=this.children.length,n=Math.ceil(e.length/r);for(t=0;t<i;t++)this.children[t].textures=e.slice(t*r,(t+1)*r);for(t=i;t<n;t++)this.addChild(new p.RectTileLayer(this.zIndex,e.slice(t*r,(t+1)*r)))},t.prototype.clear=function(){for(var e=0;e<this.children.length;e++)this.children[e].clear();this.modificationMarker=0},t.prototype.addRect=function(e,t,r,i,n,a,o){this.children[e]&&this.children[e].textures&&this.children[e].addRect(0,t,r,i,n,a,o)},t.prototype.addFrame=function(e,t,r,i,n){var a,o=null,s=0,u=this.children;if("number"==typeof e){if(o=u[e/this.texPerChild>>0])s=e%this.texPerChild;else{if(!(o=u[0]))return!1;s=0}a=o.textures[s]}else if("string"==typeof e)a=c.Texture.fromImage(e);else{a=e;for(var h=0;h<u.length;h++){for(var l=(f=u[h]).textures,d=0;d<l.length;d++)if(l[d].baseTexture==a.baseTexture){o=f,s=d;break}if(o)break}if(!o){for(h=0;h<u.length;h++){var f;if((f=u[h]).textures.length<this.texPerChild){s=(o=f).textures.length,f.textures.push(a);break}}o||(u.push(o=new p.RectTileLayer(this.zIndex,a)),s=0)}}return o.addRect(s,a.frame.x,a.frame.y,t,r,a.frame.width,a.frame.height,i,n),!0},t.prototype.renderCanvas=function(e){if(!e.plugins.tilemap.dontUseTransform){var t=this.worldTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution)}for(var r=this.children,i=0;i<r.length;i++)r[i].renderCanvas(e)},t.prototype.renderWebGL=function(e){e.gl;var t=e.plugins.tilemap.getShader(this.useSquare);if(e.setObjectRenderer(e.plugins.tilemap),e.bindShader(t),this._globalMat=this._globalMat||new c.Matrix,e._activeRenderTarget.projectionMatrix.copy(this._globalMat).append(this.worldTransform),t.uniforms.projectionMatrix=this._globalMat.toArray(!0),t.uniforms.shadowColor=this.shadowColor,this.useSquare){var r=this._tempScale=this._tempScale||[0,0];r[0]=0<=this._globalMat.a?1:-1,r[1]=this._globalMat.d<0?1:-1,t.uniforms.pointScale=r,t.uniforms.projectionScale=Math.abs(this.worldTransform.a)*e.resolution}t.uniforms.animationFrame=e.plugins.tilemap.tileAnim;for(var i=this.children,n=0;n<i.length;n++)i[n].renderWebGL(e,this.useSquare)},t.prototype.isModified=function(e){var t=this.children;if(this.modificationMarker!=t.length)return!0;for(var r=0;r<t.length;r++){var i=t[r];if(i.modificationMarker!=i.pointsBuf.length||e&&i.hasAnim)return!0}return!1},t.prototype.clearModify=function(){var e=this.children;this.modificationMarker=e.length;for(var t=0;t<e.length;t++){var r=e[t];r.modificationMarker=r.pointsBuf.length}},e=t,p.CompositeRectTileLayer=e}(PIXI||(PIXI={})),function(r){var i;function e(e){var t=i.call(this)||this;return t.z=t.zIndex=e,t}r.tilemap||(r.tilemap={}),i=r.Graphics,__extends(e,i),e.prototype.renderCanvas=function(e){var t=null;e.plugins.tilemap.dontUseTransform&&(t=this.transform.worldTransform,this.transform.worldTransform=r.Matrix.IDENTITY),e.plugins.graphics.render(this),e.plugins.tilemap.dontUseTransform&&(this.transform.worldTransform=t),e.context.globalAlpha=1},e.prototype.renderWebGL=function(e){this._webGL[e.CONTEXT_UID]||(this.dirty=!0),i.prototype.renderWebGL.call(this,e)},e.prototype.isModified=function(e){return!1},e.prototype.clearModify=function(){}}(PIXI||(PIXI={})),function(e){var t,i,r;function n(e,t){var r=i.call(this)||this;return r.z=0,r.zIndex=0,r.pointsBuf=[],r._tempSize=new Float32Array([0,0]),r._tempTexSize=1,r.modificationMarker=0,r.hasAnim=!1,r.vbId=0,r.vbBuffer=null,r.vbArray=null,r.vbInts=null,r.initialize(e,t),r}t=e.tilemap||(e.tilemap={}),i=e.Container,__extends(n,i),n.prototype.initialize=function(e,t){t?t instanceof Array||!t.baseTexture||(t=[t]):t=[],this.textures=t,this.z=this.zIndex=e,this.visible=!1},n.prototype.clear=function(){this.pointsBuf.length=0,this.modificationMarker=0,this.hasAnim=!1},n.prototype.renderCanvas=function(e){if(0!==this.textures.length){var t=this.pointsBuf;e.context.fillStyle="#000000";for(var r=0,i=t.length;r<i;r+=9){var n=t[r],a=t[r+1],o=t[r+2],s=t[r+3],u=t[r+4],h=t[r+5];n+=t[r+6]*e.plugins.tilemap.tileAnim[0],a+=t[r+7]*e.plugins.tilemap.tileAnim[1];var l=t[r+8];0<=l?e.context.drawImage(this.textures[l].baseTexture.source,n,a,u,h,o,s,u,h):(e.context.globalAlpha=.5,e.context.fillRect(o,s,u,h),e.context.globalAlpha=1)}}},n.prototype.addRect=function(e,t,r,i,n,a,o,s,u){void 0===s&&(s=0),void 0===u&&(u=0);var h,l=this.pointsBuf;if(this.hasAnim=this.hasAnim||0<s||0<u,a==o)l.push(t),l.push(r),l.push(i),l.push(n),l.push(a),l.push(o),l.push(0|s),l.push(0|u),l.push(e);else if(a%o==0)for(h=0;h<a/o;h++)l.push(t+h*o),l.push(r),l.push(i+h*o),l.push(n),l.push(o),l.push(o),l.push(0|s),l.push(0|u),l.push(e);else if(o%a==0)for(h=0;h<o/a;h++)l.push(t),l.push(r+h*a),l.push(i),l.push(n+h*a),l.push(a),l.push(a),l.push(0|s),l.push(0|u),l.push(e);else l.push(t),l.push(r),l.push(i),l.push(n),l.push(a),l.push(o),l.push(0|s),l.push(0|u),l.push(e)},n.prototype.renderWebGL=function(e,t){void 0===t&&(t=!1);var r=this.pointsBuf;if(0!==r.length){var i=r.length/9,n=e.plugins.tilemap,a=e.gl;t||n.checkIndexBuffer(i);var o=n.getShader(t),s=this.textures;if(0!==s.length){var u=s.length;this._tempTexSize<o.maxTextures&&(this._tempTexSize=o.maxTextures,this._tempSize=new Float32Array(2*o.maxTextures));for(var h=0;h<u;h++){if(!s[h]||!s[h].valid)return;s[h].baseTexture}n.bindTextures(e,o,s);var l=n.getVb(this.vbId);l||(l=n.createVb(t),this.vbId=l.id,this.vbBuffer=null,this.modificationMarker=0);var d=l.vao;e.bindVao(d);var f=l.vb;f.bind();var c=i*o.vertPerQuad;if(0!=c){if(this.modificationMarker!=c){this.modificationMarker=c;var p=o.stride*c;if(!this.vbBuffer||this.vbBuffer.byteLength<p){for(var v=o.stride;v<p;)v*=2;this.vbBuffer=new ArrayBuffer(v),this.vbArray=new Float32Array(this.vbBuffer),this.vbInts=new Uint32Array(this.vbBuffer),f.upload(this.vbBuffer,0,!0)}var m,x,T,g=this.vbArray,b=(this.vbInts,0);if(t)for(h=0;h<r.length;h+=9)m=r[h+8]>>2,x=1024*(1&r[h+8]),T=1024*(r[h+8]>>1&1),g[b++]=r[h+2],g[b++]=r[h+3],g[b++]=r[h+0]+x,g[b++]=r[h+1]+T,g[b++]=r[h+4],g[b++]=r[h+6],g[b++]=r[h+7],g[b++]=m;else for(h=0;h<r.length;h+=9){m=r[h+8]>>2,x=1024*(1&r[h+8]),T=1024*(r[h+8]>>1&1);var y=r[h+2],S=r[h+3],I=r[h+4],_=r[h+5],A=r[h]+x,C=r[h+1]+T,w=r[h+6],L=r[h+7];g[b++]=y,g[b++]=S,g[b++]=A,g[b++]=C,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y+I,g[b++]=S,g[b++]=A+I,g[b++]=C,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y+I,g[b++]=S+_,g[b++]=A+I,g[b++]=C+_,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y,g[b++]=S+_,g[b++]=A,g[b++]=C+_,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m}f.upload(g,0,!0)}t?a.drawArrays(a.POINTS,0,c):a.drawElements(a.TRIANGLES,6*i,a.UNSIGNED_SHORT,0)}}}},r=n,t.RectTileLayer=r}(PIXI||(PIXI={})),function(s){!function(a){var o,e=(o=s.Shader,__extends(t,o),t);function t(e,t,r,i){var n=o.call(this,e,r,i)||this;return n.maxTextures=0,n.maxTextures=t,a.shaderGenerator.fillSamplers(n,n.maxTextures),n}a.TilemapShader=e;var i,r=(__extends(n,i=e),n.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aFrame,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,32).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,40)},n);function n(e,t){var r=i.call(this,e,t,"\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aFrame;\nattribute vec2 aAnim;\nattribute float aTextureId;\n\nuniform mat3 projectionMatrix;\nuniform vec2 animationFrame;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vFrame;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vec2 anim = aAnim * animationFrame;\n   vTextureCoord = aTextureCoord + anim;\n   vFrame = aFrame + vec4(anim, anim);\n   vTextureId = aTextureId;\n}\n",a.shaderGenerator.generateFragmentSrc(t,"varying vec2 vTextureCoord;\nvarying vec4 vFrame;\nvarying float vTextureId;\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\n\nvoid main(void){\n   vec2 textureCoord = clamp(vTextureCoord, vFrame.xy, vFrame.zw);\n   float textureId = floor(vTextureId + 0.5);\n\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}"))||this;return r.vertSize=11,r.vertPerQuad=4,r.stride=4*r.vertSize,a.shaderGenerator.fillSamplers(r,r.maxTextures),r}a.RectTileShader=r}(s.tilemap||(s.tilemap={}))}(PIXI||(PIXI={})),function(e){var t,r;t=e.tilemap||(e.tilemap={}),(r=t.shaderGenerator||(t.shaderGenerator={})).fillSamplers=function(e,t){for(var r=[],i=0;i<t;i++)r[i]=i;e.bind(),e.uniforms.uSamplers=r;var n=[];for(i=0;i<t;i++)n.push(1/2048),n.push(1/2048);e.uniforms.uSamplerSize=n},r.generateFragmentSrc=function(e,t){return t.replace(/%count%/gi,e+"").replace(/%forloop%/gi,this.generateSampleSrc(e))},r.generateSampleSrc=function(e){var t="";t+="\n",t+="\n",t+="if(vTextureId <= -1.0) {",t+="\n\tcolor = shadowColor;",t+="\n}";for(var r=0;r<e;r++)t+="\nelse ",r<e-1&&(t+="if(textureId == "+r+".0)"),t+="\n{",t+="\n\tcolor = texture2D(uSamplers["+r+"], textureCoord * uSamplerSize["+r+"]);",t+="\n}";return t+="\n",t+="\n"}}(PIXI||(PIXI={})),function(e){var i,n,t;function r(e,t){var r=n.call(this,e,t,"\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec2 aAnim;\nattribute float aTextureId;\nattribute float aSize;\n\nuniform mat3 projectionMatrix;\nuniform vec2 samplerSize;\nuniform vec2 animationFrame;\nuniform float projectionScale;\n\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition + aSize * 0.5, 1.0)).xy, 0.0, 1.0);\n   gl_PointSize = aSize * projectionScale;\n   vTextureCoord = aTextureCoord + aAnim * animationFrame;\n   vTextureId = aTextureId;\n   vSize = aSize;\n}\n",i.shaderGenerator.generateFragmentSrc(t,"\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\nuniform vec2 pointScale;\n\nvoid main(void){\n   float margin = 0.5 / vSize;\n   vec2 pointCoord = (gl_PointCoord - 0.5) * pointScale + 0.5;\n   vec2 clamped = vec2(clamp(pointCoord.x, margin, 1.0 - margin), clamp(pointCoord.y, margin, 1.0 - margin));\n   vec2 textureCoord = pointCoord * vSize + vTextureCoord;\n   float textureId = vTextureId;\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}\n\n"))||this;return r.vertSize=8,r.vertPerQuad=1,r.stride=4*r.vertSize,r.maxTextures=t,i.shaderGenerator.fillSamplers(r,r.maxTextures),r}i=e.tilemap||(e.tilemap={}),n=i.TilemapShader,__extends(r,n),r.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aSize,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,20).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,28)},t=r,i.SquareTileShader=t}(PIXI||(PIXI={})),function(o){var r,s,i,e;function f(e,t,r,i,n){var a=e.gl,o=t.texture.baseTexture;r&&0<i&&0<n&&a.texSubImage2D(a.TEXTURE_2D,0,t.position.x,t.position.y,i,n,e.format,e.type,r),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),a.texSubImage2D(a.TEXTURE_2D,0,t.position.x,t.position.y,e.format,e.type,o.source)}function c(e){var t=i.call(this,e)||this;return t.vbs={},t.indices=new Uint16Array(0),t.lastTimeCheck=0,t.tileAnim=[0,0],t.maxTextures=4,t.texLoc=[],t}r=o.tilemap||(o.tilemap={}),s=o.glCore,i=o.ObjectRenderer,__extends(c,i),c.prototype.onContextChange=function(){var e=this.renderer.gl,t=this.maxTextures;this.rectShader=new r.RectTileShader(e,t),this.squareShader=new r.SquareTileShader(e,t),this.checkIndexBuffer(2e3),this.rectShader.indexBuffer=this.indexBuffer,this.squareShader.indexBuffer=this.indexBuffer,this.vbs={},this.glTextures=[],this.boundSprites=[],this.initBounds()},c.prototype.initBounds=function(){this.renderer.gl;var e=document.createElement("canvas");e.width=2048,e.height=2048;for(var t=0;t<this.maxTextures;t++){var r=o.RenderTexture.create(2048,2048);r.baseTexture.premultipliedAlpha=!0,r.baseTexture.scaleMode=c.SCALE_MODE,r.baseTexture.wrapMode=o.WRAP_MODES.CLAMP,this.renderer.textureManager.updateTexture(r),this.glTextures.push(r);for(var i=[],n=0;n<4;n++){var a=new o.Sprite;a.position.x=1024*(1&n),a.position.y=1024*(n>>1),i.push(a)}this.boundSprites.push(i)}},c.prototype.bindTextures=function(e,t,r){var i=this.boundSprites,n=this.glTextures,a=r.length,o=this.maxTextures;if(!(4*o<a)){var s,u=c.DO_CLEAR;for(u&&!this._clearBuffer&&(this._clearBuffer=new Uint8Array(4194304)),s=0;s<a;s++){var h=r[s];if(h&&r[s].valid){var l=i[s>>2][3&s];if(!l.texture||l.texture.baseTexture!==h.baseTexture){l.texture=h;var d=n[s>>2];e.bindTexture(d,0,!0),u?f(d.baseTexture._glTextures[e.CONTEXT_UID],l,this._clearBuffer,1024,1024):f(d.baseTexture._glTextures[e.CONTEXT_UID],l)}}}for(s=this.texLoc.length=0;s<o;s++)this.texLoc.push(e.bindTexture(n[s],s,!0));t.uniforms.uSamplers=this.texLoc}},c.prototype.checkLeaks=function(){var e=Date.now(),t=e-1e4;if(this.lastTimeCheck<t||this.lastTimeCheck>e){this.lastTimeCheck=e;var r=this.vbs;for(var i in r)r[i].lastTimeAccess<t&&this.removeVb(i)}},c.prototype.start=function(){this.renderer.state.setBlendMode(o.BLEND_MODES.NORMAL)},c.prototype.getVb=function(e){this.checkLeaks();var t=this.vbs[e];return t?(t.lastAccessTime=Date.now(),t):null},c.prototype.createVb=function(e){var t=++c.vbAutoincrement,r=this.getShader(e),i=this.renderer.gl,n=o.glCore.GLBuffer.createVertexBuffer(i,null,i.STREAM_DRAW),a={id:t,vb:n,vao:r.createVao(this.renderer,n),lastTimeAccess:Date.now(),useSquare:e,shader:r};return this.vbs[t]=a},c.prototype.removeVb=function(e){this.vbs[e]&&(this.vbs[e].vb.destroy(),this.vbs[e].vao.destroy(),delete this.vbs[e])},c.prototype.checkIndexBuffer=function(e){var t=6*e,r=this.indices;if(!(t<=r.length)){for(var i=r.length||t;i<t;)i<<=1;r=new Uint16Array(i),this.indices=r;for(var n=0,a=0;n+5<r.length;n+=6,a+=4)r[n+0]=a+0,r[n+1]=a+1,r[n+2]=a+2,r[n+3]=a+0,r[n+4]=a+2,r[n+5]=a+3;if(this.indexBuffer)this.indexBuffer.upload(r);else{var o=this.renderer.gl;this.indexBuffer=s.GLBuffer.createIndexBuffer(o,this.indices,o.STATIC_DRAW)}}},c.prototype.getShader=function(e){return e?this.squareShader:this.rectShader},c.prototype.destroy=function(){i.prototype.destroy.call(this),this.rectShader.destroy(),this.squareShader.destroy(),this.rectShader=null,this.squareShader=null},(e=c).vbAutoincrement=0,e.SCALE_MODE=o.SCALE_MODES.LINEAR,e.DO_CLEAR=!1,r.TileRenderer=e,o.WebGLRenderer.registerPlugin("tilemap",e)}(PIXI||(PIXI={})),function(o){var e,i,t;function r(e,t){var r=i.call(this)||this;return r._lastAnimationFrame=-1,r.tilemap=e,r.z=t,r}e=o.tilemap||(o.tilemap={}),i=o.Container,__extends(r,i),r.prototype.clear=function(){for(var e=this.children,t=0;t<e.length;t++)e[t].clear();this._previousLayers=0},r.prototype.cacheIfDirty=function(){var e=this.tilemap,t=this.children,r=this._previousLayers!=t.length;this._previousLayers=t.length;var i,n=this.canvasBuffer,a=this._tempRender;if(n||(n=this.canvasBuffer=document.createElement("canvas"),(a=this._tempRender=new o.CanvasRenderer(100,100,{view:n})).context=a.rootContext,a.plugins.tilemap.dontUseTransform=!0),n.width==e._layerWidth&&n.height==e._layerHeight||(n.width=e._layerWidth,n.height=e._layerHeight,r=!0),!r)for(i=0;i<t.length;i++)if(t[i].isModified(this._lastAnimationFrame!=e.animationFrame)){r=!0;break}if(this._lastAnimationFrame=e.animationFrame,r)for(e._hackRenderer&&e._hackRenderer(a),a.context.clearRect(0,0,n.width,n.height),i=0;i<t.length;i++)t[i].clearModify(),t[i].renderCanvas(a);for(this.layerTransform=this.worldTransform,i=0;i<t.length;i++){this.layerTransform=t[i].worldTransform;break}},r.prototype.renderCanvas=function(e){this.cacheIfDirty();var t=this.layerTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution),this.tilemap,e.context.drawImage(this.canvasBuffer,0,0)},t=r,e.ZLayer=t}(PIXI||(PIXI={}));